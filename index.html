<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doc Search - Zoom Control</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* PDF Canvas Container */
        #pdf-render-container {
            display: flex;
            justify-content: center;
            background-color: #525659; /* Standard PDF Viewer Background */
            padding: 2rem;
            min-height: 100%;
        }
        
        canvas {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            max-width: none !important; /* Allow canvas to scale with zoom */
            height: auto !important;
        }

        /* Highlight Marker in Text */
        .highlight-text {
            background-color: #fef08a; /* Yellow-200 */
            color: #854d0e; /* Yellow-800 */
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            border-bottom: 2px solid #eab308;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- TOAST NOTIFICATION -->
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-3"></div>

    <!-- MAIN LAYOUT -->
    <div class="flex h-full max-w-[1920px] mx-auto w-full shadow-2xl bg-white overflow-hidden">
        
        <!-- SIDEBAR: INPUT & RESULTS -->
        <div class="w-full md:w-5/12 lg:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-lg">
            <!-- Header -->
            <div class="p-5 border-b border-gray-100 bg-gray-50">
                <h1 class="text-xl font-bold text-blue-800 flex items-center gap-2">
                    <i data-lucide="scan-search" class="w-6 h-6"></i>
                    Smart Search
                </h1>
                <p class="text-xs text-gray-500 mt-1">Tìm kiếm & Highlight bản gốc</p>
            </div>

            <!-- Search Inputs -->
            <div class="p-5 bg-white space-y-4 shadow-sm z-20">
                <!-- File Input -->
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-blue-50 transition cursor-pointer relative bg-gray-50 group">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.xls,.csv,.txt,.html" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                    <div class="flex flex-col items-center">
                        <i data-lucide="upload" class="w-6 h-6 text-gray-400 mb-1"></i>
                        <p class="text-sm font-medium text-gray-600" id="fileCountLabel">Chọn tài liệu để tra cứu</p>
                    </div>
                </div>

                <!-- Keyword Input -->
                <div class="relative">
                    <input type="text" id="keywordInput" placeholder="Nhập từ khóa cần tìm..." 
                        class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm bg-gray-50 focus:bg-white transition"
                        onkeypress="if(event.key === 'Enter') processFiles()">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5"></i>
                </div>

                <div class="flex gap-2">
                    <button onclick="processFiles()" id="btnProcess" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg shadow-sm transition active:scale-95 flex items-center justify-center gap-2">
                        <span>Tìm kiếm</span>
                    </button>
                    <label class="flex items-center justify-center px-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50" title="Dùng OCR cho ảnh">
                        <input type="checkbox" id="useOCR" class="mr-2"> <span class="text-xs font-medium">OCR</span>
                    </label>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden px-5 pt-2">
                <div class="flex justify-between text-xs mb-1 text-gray-600">
                    <span id="progressText">Đang xử lý...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-1">
                    <div id="progressBar" class="bg-blue-600 h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Results List (Scrollable) -->
            <div id="resultsList" class="flex-1 overflow-y-auto p-5 space-y-4 bg-gray-50">
                <div id="emptyState" class="flex flex-col items-center justify-center h-48 text-gray-400 text-center">
                    <i data-lucide="layers" class="w-10 h-10 mb-2 opacity-20"></i>
                    <p class="text-sm">Kết quả tìm kiếm sẽ xuất hiện ở đây</p>
                </div>
            </div>
        </div>

        <!-- MAIN VIEWER (RIGHT SIDE) -->
        <div class="flex-1 bg-gray-800 flex flex-col h-full relative overflow-hidden">
            <!-- Viewer Toolbar -->
            <div class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-6 shadow-sm z-30">
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <h3 id="viewerTitle" class="font-bold text-gray-800 truncate max-w-[150px] md:max-w-xs">Chưa chọn tài liệu</h3>
                    <span id="viewerPageInfo" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hidden whitespace-nowrap">Trang 1</span>
                </div>
                
                <!-- NEW: ZOOM CONTROLS -->
                <div class="flex items-center gap-1.5 md:gap-3 bg-gray-50 p-1 rounded-lg border border-gray-200">
                    <!-- Page Nav -->
                    <div class="flex items-center">
                        <button onclick="changePage(-1)" class="p-1.5 hover:bg-white hover:shadow-sm rounded-md text-gray-600 disabled:opacity-30 transition" id="btnPrev">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <button onclick="changePage(1)" class="p-1.5 hover:bg-white hover:shadow-sm rounded-md text-gray-600 disabled:opacity-30 transition" id="btnNext">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="h-4 w-px bg-gray-300"></div>

                    <!-- Zoom Controls -->
                    <div class="flex items-center gap-1">
                        <button onclick="applyZoom(-0.1)" class="p-1.5 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition" title="Thu nhỏ">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        
                        <div class="relative group">
                            <select id="zoomSelect" onchange="setSpecificZoom(this.value)" 
                                class="appearance-none bg-transparent text-xs font-semibold text-gray-700 w-16 text-center focus:outline-none cursor-pointer py-1">
                                <option value="0.5">50%</option>
                                <option value="0.75">75%</option>
                                <option value="1.0" selected>100%</option>
                                <option value="1.25">125%</option>
                                <option value="1.5">150%</option>
                                <option value="1.75">175%</option>
                                <option value="2.0">200%</option>
                                <option value="2.5">250%</option>
                                <option value="3.0">300%</option>
                            </select>
                            <!-- Custom arrow for select -->
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-gray-500">
                                <svg class="h-3 w-3 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                            </div>
                        </div>

                        <button onclick="applyZoom(0.1)" class="p-1.5 hover:bg-white hover:shadow-sm rounded-md text-gray-600 transition" title="Phóng to">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Document Render Area -->
            <div id="docViewerContainer" class="flex-1 overflow-auto relative bg-slate-700 scroll-smooth">
                <!-- PDF Canvas or HTML Content will go here -->
                <div id="pdf-render-container" class="hidden"></div>
                <div id="html-render-container" class="hidden p-8 max-w-4xl mx-auto bg-white min-h-screen shadow-lg transition-transform origin-top-center"></div>
                
                <!-- Welcome Placeholder -->
                <div id="viewerPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 select-none pointer-events-none">
                    <i data-lucide="file-search" class="w-16 h-16 mb-4 opacity-10 text-white"></i>
                    <p class="text-gray-500">Chọn kết quả bên trái để xem bản gốc</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let uploadedFiles = []; 
        let currentPdfDoc = null;
        let currentPageNum = 1;
        let currentScale = 1.0; // Default 100%
        let currentFileIndex = -1;
        let globalKeyword = "";

        // --- UTILS: TOAST ---
        function showToast(msg, type='info') {
            const box = document.createElement('div');
            box.className = `p-3 rounded-lg shadow-lg text-white text-sm flex items-center gap-2 animate-fade-in ${type==='error'?'bg-red-600':'bg-blue-600'}`;
            box.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(box);
            lucide.createIcons();
            setTimeout(()=>box.remove(), 3000);
        }

        // --- UI HANDLERS ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function() {
            if(this.files.length > 0) {
                uploadedFiles = Array.from(this.files); 
                document.getElementById('fileCountLabel').innerText = `Đã chọn ${this.files.length} file`;
                document.getElementById('fileCountLabel').className = "text-sm font-bold text-blue-600";
            }
        });

        // --- ZOOM LOGIC ---
        function updateZoomUI(scale) {
            const select = document.getElementById('zoomSelect');
            const percent = Math.round(scale * 100);
            
            // Try to find exact match in options
            let matched = false;
            for(let opt of select.options) {
                if(Math.abs(parseFloat(opt.value) - scale) < 0.05) {
                    select.value = opt.value;
                    matched = true;
                    break;
                }
            }
            
            // If custom zoom level (via buttons), we might want to show it roughly or just leave it
            // For simplicity, we just keep the value logic internal if not matched perfectly
        }

        function setSpecificZoom(val) {
            currentScale = parseFloat(val);
            refreshCurrentView();
        }

        function applyZoom(delta) {
            let newScale = currentScale + delta;
            newScale = Math.max(0.5, Math.min(3.0, newScale)); // Limit 50% - 300%
            currentScale = newScale;
            
            updateZoomUI(currentScale);
            refreshCurrentView();
        }

        function refreshCurrentView() {
            if(currentFileIndex === -1) return;
            // Re-call viewOriginal with current parameters
            viewOriginal(currentFileIndex, currentPageNum, true); // true = prevent scroll reset if desired
        }

        // --- SEARCH ENGINE ---
        async function processFiles() {
            globalKeyword = document.getElementById('keywordInput').value.trim().toLowerCase();
            if(!globalKeyword || uploadedFiles.length === 0) return showToast('Nhập từ khóa và chọn file!', 'error');

            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsList').innerHTML = '';

            const resultsList = document.getElementById('resultsList');
            let totalMatches = 0;

            for(let i=0; i<uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                updateProgress((i/uploadedFiles.length)*100, `Đang quét: ${file.name}`);
                
                const pages = await extractTextForIndexing(file);
                
                const matches = [];
                pages.forEach(page => {
                    if(page.text.toLowerCase().includes(globalKeyword)) {
                        const idx = page.text.toLowerCase().indexOf(globalKeyword);
                        const start = Math.max(0, idx - 60);
                        const end = Math.min(page.text.length, idx + 150);
                        let snippet = page.text.substring(start, end);
                        
                        const regex = new RegExp(`(${globalKeyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        snippet = snippet.replace(regex, '<span class="highlight-text">$1</span>');

                        matches.push({ pageNum: page.pageNum, snippet: "..." + snippet + "..." });
                    }
                });

                if(matches.length > 0) {
                    totalMatches += matches.length;
                    renderResultCard(resultsList, file.name, i, matches);
                }
            }

            updateProgress(100, 'Hoàn tất');
            setTimeout(() => document.getElementById('progressContainer').classList.add('hidden'), 1000);
            
            if(totalMatches === 0) {
                resultsList.innerHTML = `<div class="text-center text-gray-500 py-10">Không tìm thấy kết quả nào.</div>`;
            }
        }

        async function extractTextForIndexing(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if(ext === 'pdf') return await parsePDFText(file);
            if(ext === 'docx') return await parseDOCXText(file);
            if(['xlsx','xls','csv'].includes(ext)) return await parseExcelText(file);
            return await parsePlainText(file);
        }

        // --- PARSERS ---
        async function parsePDFText(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(ab).promise;
            const pages = [];
            const useOCR = document.getElementById('useOCR').checked;
            let worker = useOCR ? await Tesseract.createWorker('vie') : null;

            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                let text = "";
                if(useOCR) {
                    const vp = page.getViewport({scale: 1.0});
                    const cvs = document.createElement('canvas');
                    cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({canvasContext: cvs.getContext('2d'), viewport: vp}).promise;
                    const res = await worker.recognize(cvs);
                    text = res.data.text;
                } else {
                    const content = await page.getTextContent();
                    text = content.items.map(item => item.str).join(' ');
                }
                pages.push({pageNum: i, text: text});
            }
            if(worker) await worker.terminate();
            return pages;
        }

        async function parseDOCXText(file) {
            const ab = await file.arrayBuffer();
            const res = await mammoth.extractRawText({arrayBuffer: ab});
            return [{pageNum: 1, text: res.value}];
        }

        async function parseExcelText(file) {
            const ab = await file.arrayBuffer();
            const wb = XLSX.read(ab, {type:'array'});
            const pages = [];
            wb.SheetNames.forEach((name, i) => {
                const txt = XLSX.utils.sheet_to_csv(wb.Sheets[name]);
                if(txt.trim()) pages.push({pageNum: i+1, text: txt});
            });
            return pages;
        }

        async function parsePlainText(file) {
            return new Promise(r => {
                const fr = new FileReader();
                fr.onload = e => r([{pageNum: 1, text: e.target.result}]);
                fr.readAsText(file);
            });
        }

        // --- RENDER CARD ---
        function renderResultCard(container, fileName, fileIndex, matches) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition";
            
            let icon = 'file';
            if(fileName.endsWith('pdf')) icon = 'file-text';
            if(fileName.endsWith('docx')) icon = 'file-type-2';
            
            const matchesHTML = matches.map((m, idx) => `
                <div onclick="viewOriginal(${fileIndex}, ${m.pageNum})" 
                     class="cursor-pointer p-3 hover:bg-blue-50 transition border-l-4 border-transparent hover:border-blue-500 group">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-600 px-2 py-0.5 rounded group-hover:bg-blue-200 group-hover:text-blue-800">
                            Trang ${m.pageNum}
                        </span>
                        <span class="text-xs text-blue-600 font-medium opacity-0 group-hover:opacity-100 transition flex items-center gap-1">
                            Xem bản gốc <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed line-clamp-3">
                        "${m.snippet}"
                    </p>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex items-center gap-2">
                    <i data-lucide="${icon}" class="w-4 h-4 text-blue-600"></i>
                    <h3 class="font-bold text-sm text-gray-800 truncate flex-1" title="${fileName}">${fileName}</h3>
                    <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">${matches.length}</span>
                </div>
                <div class="divide-y divide-gray-50">
                    ${matchesHTML}
                </div>
            `;
            container.appendChild(card);
            lucide.createIcons();
        }

        // --- VIEWER LOGIC ---
        
        async function viewOriginal(fileIndex, pageNum, preserveView = false) {
            const file = uploadedFiles[fileIndex];
            
            // Only clear if changing file
            const isFileChange = currentFileIndex !== fileIndex;
            currentFileIndex = fileIndex;
            currentPageNum = pageNum;

            // Update UI
            document.getElementById('viewerPlaceholder').classList.add('hidden');
            document.getElementById('viewerTitle').innerText = file.name;
            document.getElementById('viewerPageInfo').classList.remove('hidden');
            document.getElementById('viewerPageInfo').innerText = `Trang ${pageNum}`;
            
            const pdfContainer = document.getElementById('pdf-render-container');
            const htmlContainer = document.getElementById('html-render-container');
            const ext = file.name.split('.').pop().toLowerCase();

            if (ext === 'pdf') {
                pdfContainer.classList.remove('hidden');
                htmlContainer.classList.add('hidden');
                
                // If refreshing zoom (preserveView), we re-render canvas
                // We wipe content to redraw
                pdfContainer.innerHTML = '';
                await renderPDFPage(file, pageNum);

            } else {
                htmlContainer.classList.remove('hidden');
                pdfContainer.classList.add('hidden');
                
                if (isFileChange || !htmlContainer.innerHTML) {
                    htmlContainer.innerHTML = '';
                    await renderHTMLContent(file, pageNum);
                } else {
                    // Just update Zoom
                    htmlContainer.style.transform = `scale(${currentScale})`;
                    // If zoom > 1, ensure origin is top-center or let user scroll
                    if(currentScale > 1) htmlContainer.style.transformOrigin = 'top left'; 
                    else htmlContainer.style.transformOrigin = 'top center';
                }
            }
        }

        // 1. PDF RENDERER
        async function renderPDFPage(file, pageNum) {
            if(!currentPdfDoc || currentPdfDoc.fileName !== file.name) {
                const ab = await file.arrayBuffer();
                currentPdfDoc = await pdfjsLib.getDocument(ab).promise;
                currentPdfDoc.fileName = file.name;
            }

            const page = await currentPdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: currentScale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const container = document.getElementById('pdf-render-container');
            container.appendChild(canvas);

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // --- HIGHLIGHT LOGIC ---
            if(globalKeyword) {
                const textContent = await page.getTextContent();
                context.globalAlpha = 0.4;
                context.fillStyle = '#ffff00';

                textContent.items.forEach(item => {
                    if (item.str.toLowerCase().includes(globalKeyword)) {
                        const tx = item.transform;
                        const x = tx[4];
                        const y = tx[5];
                        const w = item.width;
                        const h = Math.abs(tx[3]); 
                        const rect = viewport.convertToViewportRectangle([x, y, x + w, y + h]);
                        const minX = Math.min(rect[0], rect[2]);
                        const maxX = Math.max(rect[0], rect[2]);
                        const minY = Math.min(rect[1], rect[3]);
                        const maxY = Math.max(rect[1], rect[3]);
                        context.fillRect(minX, minY, maxX - minX, maxY - minY);
                    }
                });
                context.globalAlpha = 1.0;
            }

            document.getElementById('btnPrev').disabled = pageNum <= 1;
            document.getElementById('btnNext').disabled = pageNum >= currentPdfDoc.numPages;
            document.getElementById('viewerPageInfo').innerText = `Trang ${pageNum} / ${currentPdfDoc.numPages}`;
        }

        // 2. HTML RENDERER
        async function renderHTMLContent(file, pageNum) {
            const container = document.getElementById('html-render-container');
            // Reset Scale for new render
            container.style.transform = `scale(${currentScale})`;
            container.style.transformOrigin = currentScale > 1 ? 'top left' : 'top center';

            const ext = file.name.split('.').pop().toLowerCase();
            let html = "";

            if(ext === 'docx') {
                const ab = await file.arrayBuffer();
                const res = await mammoth.convertToHtml({arrayBuffer: ab});
                html = `<div class="prose max-w-none text-justify">${res.value}</div>`;
            } else if(['xlsx','xls','csv'].includes(ext)) {
                const ab = await file.arrayBuffer();
                const wb = XLSX.read(ab, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[pageNum-1] || wb.SheetNames[0]];
                html = XLSX.utils.sheet_to_html(ws);
                html = html.replace('<table>', '<table class="min-w-full border-collapse border border-gray-300">');
            } else {
                const text = await parsePlainText(file);
                html = `<pre class="whitespace-pre-wrap font-mono text-sm">${text[0].text}</pre>`;
            }
            
            container.innerHTML = html;

            if(globalKeyword) {
                const keyword = globalKeyword;
                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
                const nodesToReplace = [];
                let node;
                while(node = walker.nextNode()) {
                    if (node.nodeValue.toLowerCase().includes(keyword)) {
                        nodesToReplace.push(node);
                    }
                }
                nodesToReplace.forEach(node => {
                    const span = document.createElement('span');
                    span.innerHTML = node.nodeValue.replace(regex, '<span class="highlight-text">$1</span>');
                    node.parentNode.replaceChild(span, node);
                });
                
                const firstMatch = container.querySelector('.highlight-text');
                if(firstMatch) firstMatch.scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            document.getElementById('btnPrev').disabled = true;
            document.getElementById('btnNext').disabled = true;
        }

        // --- VIEWER CONTROLS ---
        function changePage(delta) {
            if(!currentPdfDoc) return;
            const newPage = currentPageNum + delta;
            if(newPage >= 1 && newPage <= currentPdfDoc.numPages) {
                viewOriginal(currentFileIndex, newPage);
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').innerText = `${Math.round(percent)}%`;
            document.getElementById('progressText').innerText = text;
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
